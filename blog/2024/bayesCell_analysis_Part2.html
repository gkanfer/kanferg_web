

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />
<meta property="og:title" content="Using the Bayesian Approach with PyMC to Analyze Functional Genomics Screens, Part 2" />
<meta property="og:type" content="website" />
<meta property="og:url" content="blog/2024/bayesCell_analysis_Part2.html" />
<meta property="og:site_name" content="MyST-NB Quickstart" />
<meta property="og:description" content="Advancing Gene Enrichment Analysis: Abundance Testing Using Bayesian Inference: Following up on our initial dive into the world of Bayesian statistics in genetics, especially within the nuances of ..." />
<meta property="og:image:width" content="1146" />
<meta property="og:image:height" content="600" />
<meta property="og:image" content="/_images/social_previews/summary_blog_2024_bayesCell_analysis_Part2_1034bc30.png" />
<meta property="og:image:alt" content="Advancing Gene Enrichment Analysis: Abundance Testing Using Bayesian Inference: Following up on our initial dive into the world of Bayesian statistics in gen..." />
<meta name="description" content="Advancing Gene Enrichment Analysis: Abundance Testing Using Bayesian Inference: Following up on our initial dive into the world of Bayesian statistics in genetics, especially within the nuances of ..." />
<meta name="twitter:card" content="summary_large_image" />

    <title>Using the Bayesian Approach with PyMC to Analyze Functional Genomics Screens, Part 2 &#8212; MyST-NB Quickstart  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=5b4479735964841361fd" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=5b4479735964841361fd" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/mycss.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=5b4479735964841361fd" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd" />
  <script src="../../_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=5b4479735964841361fd"></script>

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/design-tabs.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'blog/2024/bayesCell_analysis_Part2';</script>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>  
<style type="text/css">
  ul.ablog-archive {
    list-style: none;
    overflow: auto;
    margin-left: 0px;
  }
  ul.ablog-archive li {
    float: left;
    margin-right: 5px;
    font-size: 80%;
  }
  ul.postlist a {
    font-style: italic;
  }
  ul.postlist-style-disc {
    list-style-type: disc;
  }
  ul.postlist-style-none {
    list-style-type: none;
  }
  ul.postlist-style-circle {
    list-style-type: circle;
  }
</style>

  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this site..."
         aria-label="Search this site..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/logo_GPT_react.png" class="logo__image only-light" alt="MyST-NB Quickstart  documentation - Home"/>
    <script>document.write(`<img src="../../_static/logo_GPT_react.png" class="logo__image only-dark" alt="MyST-NB Quickstart  documentation - Home"/>`);</script>
  
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../about.html">
                        About Me
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../projects.html">
                        My projects
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../blog.html">
                        Blog
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../publications.html">
                        Publications
                      </a>
                    </li>
                
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
        </div>
      
      
        <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/gkanfer" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://twitter.com/gil_kanfer" title="Twitter" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-twitter fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">Twitter</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://www.linkedin.com/in/gil-kanfer-b8684028/" title="LinkedIn" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-linkedin fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">LinkedIn</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
    </div>
  

  
    <label class="sidebar-toggle secondary-toggle" for="__secondary" tabindex="0">
      <span class="fa-solid fa-outdent"></span>
    </label>
  
</div>

    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          <div class="navbar-item">
<nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../about.html">
                        About Me
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../projects.html">
                        My projects
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../blog.html">
                        Blog
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../publications.html">
                        Publications
                      </a>
                    </li>
                
  </ul>
</nav></div>
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/gkanfer" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://twitter.com/gil_kanfer" title="Twitter" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-twitter fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">Twitter</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://www.linkedin.com/in/gil-kanfer-b8684028/" title="LinkedIn" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-linkedin fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">LinkedIn</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    <li class="breadcrumb-item active" aria-current="page">Using the...</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                   <section class="tex2jax_ignore mathjax_ignore" id="using-the-bayesian-approach-with-pymc-to-analyze-functional-genomics-screens-part-2">
<h1>Using the Bayesian Approach with PyMC to Analyze Functional Genomics Screens, Part 2<a class="headerlink" href="#using-the-bayesian-approach-with-pymc-to-analyze-functional-genomics-screens-part-2" title="Permalink to this heading">#</a></h1>
<section id="advancing-gene-enrichment-analysis-abundance-testing-using-bayesian-inference">
<h2>Advancing Gene Enrichment Analysis: Abundance Testing Using Bayesian Inference<a class="headerlink" href="#advancing-gene-enrichment-analysis-abundance-testing-using-bayesian-inference" title="Permalink to this heading">#</a></h2>
<p>Following up on our initial dive into the world of Bayesian statistics in genetics, especially within the nuances of cell biology, here, I’m moving forward to discuss applying Bayesian inference to decipher gene abundance from CRISPR screens. At the heart of these analyses lies the crucial task of ranking gene abundance, a step pivotal for understanding genetic influences and interactions within cells.</p>
<p>In the realm of CRISPR screens, accurately determining gene abundance before and after the intervention is key to identifying genes that play significant roles in the studied condition or trait. In this context, the traditional approach often leans on straightforward comparisons and null hypothesis testing. However, the Bayesian method introduces a nuanced layer by implementing hypothesis testing in a way that incorporates prior knowledge and observed data to update our beliefs about the unknown parameters.</p>
<p>In upcoming discussions, I’ll dive into the practical steps of implementing Bayesian hypothesis testing in gene abundance analysis. This will include selecting priors based on functional genomics data, estimating parameters that reflect our biological understanding, and calculating fold changes that reveal the most impactful genes. By sharing this journey, I hope to illuminate the path for others interested in harnessing Bayesian inference for their genetic research, making the analysis of complex data more accessible and insightful.</p>
<div class="admonition-key-inspirations-for-bayesian-analysis-in-genetics admonition">
<p class="admonition-title">Key Inspirations for Bayesian Analysis in Genetics</p>
<p>My work was inspired by the great notebook from the PyMC group:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.pymc.io/projects/examples/en/latest/case_studies/BEST.html">BEST</a></p></li>
</ul>
<p>Another notebook which was very useful:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://towardsdatascience.com/a-b-testing-with-probabilistic-programming-and-pymc3-part-ii-10f0c16c8d1c">NBA</a></p></li>
</ul>
<p>The original article that informed much of this analysis is “Bayesian Estimation Supersedes the t Test” by John Kruschke and a very usfull review: <a class="reference external" href="https://doi.org/10.1186/s12874-020-00968-2">Ketlter et al</a></p>
</div>
<p>We begin our exploration by revisiting the simulation generator introduced in the first part of this blog series. This tool is pivotal in crafting our datasets for analysis, simulating the nuanced conditions we encounter in CRISPR screens. Below is the code snippet that kicks off our journey:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">runSimulation</span><span class="p">(</span><span class="n">targetNum</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">geneNum</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">effectSgRNA</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">getData</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">mu</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="mf">1.2</span><span class="p">,</span> <span class="n">low</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">10_000</span><span class="p">,</span> <span class="n">FalseLimits</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.25</span><span class="p">),</span> <span class="n">ObservationNum</span> <span class="o">=</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>With this command, we initiate the generation of three distinct datasets. Each dataset is designed to embody increasing levels of noise, achieved by adjusting the MOI (Multiplicity of Infection) levels of the screen. MOI serves as a crucial factor here, reflecting the number of unique sgRNAs expressed per cell. As we increment the MOI, we’re essentially increasing the variety of guides per cell, which, in turn, elevates the noise in our final dataset. This step mirrors the real-world scenario in genetic screens, where the diversity of sgRNA can significantly impact the clarity and interpretability of our results.</p>
<p><img alt="Pairwise Comparison Example" src="../../_images/BAyesCell_diagrame.png" /></p>
<p>By systematically increasing the MOI, we simulate conditions that range from ideal to highly challenging, providing a comprehensive view of how Bayesian inference can be adapted and applied across varying degrees of data complexity. This approach not only tests the robustness of our Bayesian models but also deepens our understanding of the intricacies involved in genetic screen data analysis.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">arviz</span> <span class="k">as</span> <span class="nn">az</span>
<span class="kn">from</span> <span class="nn">arviz</span> <span class="kn">import</span> <span class="n">hdi</span>
<span class="kn">import</span> <span class="nn">pymc</span> <span class="k">as</span> <span class="nn">pm</span>
<span class="kn">import</span> <span class="nn">pytensor.tensor</span> <span class="k">as</span> <span class="nn">pt</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">jax</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">arviz</span> <span class="kn">import</span> <span class="n">hdi</span>
<span class="kn">import</span> <span class="nn">pdb</span>
<span class="kn">import</span> <span class="nn">matplotlib.patches</span> <span class="k">as</span> <span class="nn">mpatches</span>
<span class="kn">import</span> <span class="nn">cloudpickle</span>
<span class="o">%</span><span class="n">config</span> <span class="n">InlineBackend</span><span class="o">.</span><span class="n">figure_format</span> <span class="o">=</span> <span class="s1">&#39;retina&#39;</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="p">(</span><span class="ne">FutureWarning</span><span class="p">,</span> <span class="ne">UserWarning</span><span class="p">))</span>
<span class="n">RANDOM_SEED</span> <span class="o">=</span> <span class="mi">8927</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">RANDOM_SEED</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span>
<span class="c1"># plt.style.use(&#39;fivethirtyeight&#39;)</span>
<span class="kn">from</span> <span class="nn">aipys_analyse.simulation.runSimulation</span> <span class="kn">import</span> <span class="n">runSimulation</span>
<span class="n">az</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;arviz-darkgrid&quot;</span><span class="p">)</span>
<span class="n">az</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;stats.hdi_prob&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.89</span>
<span class="n">az</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;stats.ic_scale&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;deviance&quot;</span>
<span class="n">az</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;stats.information_criterion&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;waic&quot;</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">3.5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">)</span> <span class="c1"># sinnle column</span>
<span class="c1"># #plt.rcParams[&quot;figure.figsize&quot;] = (7, 4) # double-column </span>
<span class="n">sns</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="s2">&quot;paper&quot;</span><span class="p">,</span> <span class="n">font_scale</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
<span class="c1">#sns.set_palette(&quot;colorblind&quot;)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.dpi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">150</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.family&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Times New Roman&#39;</span><span class="p">,</span> <span class="s1">&#39;serif&#39;</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.family&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;serif&#39;</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">12</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.labelsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">12</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.titlesize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">12</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;xtick.labelsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">12</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;ytick.labelsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">12</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ScreenSimulator</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">moi</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">moi</span> <span class="o">=</span> <span class="n">moi</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">siMobj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finObj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runmodel</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">simulate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">runSimulation</span><span class="p">(</span><span class="n">targetNum</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">geneNum</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">effectSgRNA</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span><span class="n">getData</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">mu</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="mf">1.2</span><span class="p">,</span><span class="n">low</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">moi</span><span class="p">,</span><span class="n">size</span> <span class="o">=</span> <span class="mi">10_000</span><span class="p">,</span><span class="n">FalseLimits</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.5</span><span class="p">),</span><span class="n">ObservationNum</span> <span class="o">=</span> <span class="p">(</span><span class="mi">70</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">runmodel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dftall</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">siMobj</span><span class="o">.</span><span class="n">dfTall</span>
        <span class="n">dftall</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dftall</span><span class="p">[</span><span class="s1">&#39;readCount&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;readCount&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">dftall</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dftall</span><span class="p">[</span><span class="s1">&#39;readCount&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="mi">1</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;readCount&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">sgRNA</span><span class="p">,</span> <span class="n">mn_sgRNA</span> <span class="o">=</span>  <span class="n">dftall_h0</span><span class="o">.</span><span class="n">sgRNA</span><span class="o">.</span><span class="n">factorize</span><span class="p">()</span>
        <span class="n">Genes</span><span class="p">,</span> <span class="n">mn_Genes</span> <span class="o">=</span> <span class="n">dftall_h0</span><span class="o">.</span><span class="n">Gene</span><span class="o">.</span><span class="n">factorize</span><span class="p">()</span>
        <span class="n">h0</span> <span class="o">=</span> <span class="n">dftall_h0</span><span class="o">.</span><span class="n">readCount</span><span class="o">.</span><span class="n">values</span>
        <span class="n">h1</span> <span class="o">=</span> <span class="n">dftall_h1</span><span class="o">.</span><span class="n">readCount</span><span class="o">.</span><span class="n">values</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">dftall_M</span><span class="o">.</span><span class="n">readCount</span><span class="o">.</span><span class="n">values</span>
        <span class="n">xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">h0</span><span class="p">),</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">xy</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">h0</span>
        <span class="n">xy</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">h1</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;sgRNA&quot;</span><span class="p">:</span> <span class="n">mn_sgRNA</span><span class="p">,</span><span class="s2">&quot;Genes&quot;</span><span class="p">:</span> <span class="n">mn_Genes</span><span class="p">,</span><span class="s2">&quot;experiment&quot;</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]}</span>
        <span class="n">coords</span><span class="p">[</span><span class="s2">&quot;experiment&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">with</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">)</span> <span class="k">as</span> <span class="n">model</span><span class="p">:</span>
          <span class="c1">#Hyper-proirs</span>
          <span class="n">beta_bar</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;beta_bar&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
          <span class="n">sigma_bar</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">HalfNormal</span><span class="p">(</span><span class="s2">&quot;sigma_bar&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
          <span class="n">theta_bar</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;theta_bar&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
          <span class="n">sigma_theta_bar</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">HalfNormal</span><span class="p">(</span><span class="s2">&quot;sigma_theta_bar&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
          <span class="c1">#Hyper-proir noncentered</span>
          <span class="n">z_beta</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;z_beta&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;sgRNA&quot;</span><span class="p">))</span>
          <span class="n">beta</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s2">&quot;beta&quot;</span><span class="p">,</span> <span class="n">beta_bar</span> <span class="o">+</span> <span class="n">z_beta</span><span class="o">*</span><span class="n">sigma_bar</span><span class="p">)</span>
        
          <span class="n">z_theta</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;z_theta&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;sgRNA&quot;</span><span class="p">))</span>
          <span class="n">theta</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;theta&quot;</span><span class="p">,</span><span class="n">theta_bar</span> <span class="o">+</span> <span class="n">z_theta</span><span class="o">*</span><span class="n">sigma_theta_bar</span><span class="p">)</span>
        
          <span class="n">chol</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">LKJCholeskyCov</span><span class="p">(</span>
              <span class="s2">&quot;chol_cov&quot;</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">sd_dist</span><span class="o">=</span><span class="n">pm</span><span class="o">.</span><span class="n">Exponential</span><span class="o">.</span><span class="n">dist</span><span class="p">(</span><span class="mf">2.0</span><span class="p">),</span> <span class="n">compute_corr</span><span class="o">=</span><span class="kc">True</span>
          <span class="p">)</span>
          <span class="n">ve</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s2">&quot;ve&quot;</span><span class="p">,</span> <span class="n">pm</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">chol</span><span class="p">,</span><span class="n">pt</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">theta</span><span class="p">,</span><span class="n">beta</span><span class="p">]))</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        
          <span class="n">Mu_Y</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s2">&quot;Mu_Y&quot;</span><span class="p">,</span><span class="n">h1</span> <span class="o">+</span> <span class="n">pm</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">ve</span><span class="p">[</span><span class="n">sgRNA</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">h0</span><span class="p">)</span>
          <span class="n">Mu_X</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s2">&quot;Mu_X&quot;</span><span class="p">,</span><span class="n">pm</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">ve</span><span class="p">[</span><span class="n">sgRNA</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">M</span><span class="p">)</span>
        
          <span class="n">XY_obs</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Data</span><span class="p">(</span><span class="s2">&quot;XY_obs&quot;</span><span class="p">,</span> <span class="n">xy</span><span class="p">,</span> <span class="n">mutable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
          <span class="n">sigma</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Gamma</span><span class="p">(</span><span class="s2">&quot;sigma&quot;</span><span class="p">,</span><span class="n">mu</span> <span class="o">=</span> <span class="mf">28.5</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="mf">10.5</span><span class="p">,</span><span class="n">dims</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;experiment&quot;</span><span class="p">))</span>
        
          <span class="n">count_h0</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">NegativeBinomial</span><span class="p">(</span><span class="s2">&quot;count_h0&quot;</span><span class="p">,</span> <span class="n">mu</span> <span class="o">=</span> <span class="n">Mu_X</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">observed</span><span class="o">=</span><span class="n">h0</span><span class="p">)</span>
          <span class="n">count_h1</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">NegativeBinomial</span><span class="p">(</span><span class="s2">&quot;count_h1&quot;</span><span class="p">,</span> <span class="n">mu</span> <span class="o">=</span> <span class="n">Mu_Y</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">observed</span><span class="o">=</span><span class="n">h1</span><span class="p">)</span>
          <span class="n">trace</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="n">tune</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">target_accept</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">chains</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="n">RANDOM_SEED</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;trace&#39;</span><span class="p">:</span><span class="n">trace</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">:</span><span class="n">h0</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">:</span><span class="n">h1</span><span class="p">,</span> <span class="s2">&quot;M&quot;</span><span class="p">:</span><span class="n">M</span><span class="p">,</span> <span class="s2">&quot;sgRNA&quot;</span><span class="p">:</span><span class="n">sgRNA</span><span class="p">,</span> <span class="s2">&quot;Genes&quot;</span><span class="p">:</span><span class="n">Genes</span><span class="p">,</span> <span class="s2">&quot;mn_sgRNA&quot;</span><span class="p">:</span><span class="n">mn_sgRNA</span><span class="p">,</span> <span class="s2">&quot;mn_Genes&quot;</span><span class="p">:</span><span class="n">mn_Genes</span><span class="p">,</span><span class="s2">&quot;coords&quot;</span><span class="p">:</span><span class="n">coords</span><span class="p">,</span><span class="s2">&quot;hit&quot;</span><span class="p">:</span><span class="n">simObj</span><span class="o">.</span><span class="n">effective_sgRNA_flat</span> <span class="p">,</span><span class="s2">&quot;dftall&quot;</span><span class="p">:</span><span class="n">simObj</span><span class="o">.</span><span class="n">dfTall</span><span class="p">,</span><span class="s2">&quot;model&quot;</span><span class="p">:</span><span class="n">model</span><span class="p">}</span> 
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">dftall_1x_dict</span> <span class="o">=</span> <span class="n">ScreenSimulator</span><span class="p">(</span><span class="n">moi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">dftall_3x_dict</span> <span class="o">=</span> <span class="n">ScreenSimulator</span><span class="p">(</span><span class="n">moi</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">dftall_10x_dict</span> <span class="o">=</span> <span class="n">ScreenSimulator</span><span class="p">(</span><span class="n">moi</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>I previously introduced a mixed-effect model to understand the dynamics of sgRNA before and after the screening process. This model, succinctly represented below, incorporates varying effects to capture the relationship between sgRNA populations and cellular outcomes:</p>
<div class="math notranslate nohighlight">
\[
(H_{t_1,i} , H_{t_0,i}) \sim \text{NB}(\mu_{ij}, \alpha)
\]</div>
<div class="math notranslate nohighlight">
\[
\mu_{ij} = \alpha + V_{ij} \times \beta_{i} \times H_{t_0,i} + V_{ij} \times \theta_{i} \times M
\]</div>
<p>Here, <span class="math notranslate nohighlight">\(\mu_{ij}\)</span> represents the model expectation for read counts, influenced by sgRNA efficiency <span class="math notranslate nohighlight">\(\beta_{i}\)</span> and master plasmid effects <span class="math notranslate nohighlight">\(\theta_{i}\)</span>.</p>
<p>To refine our analysis, especially in hypothesis testing, we integrate <span class="math notranslate nohighlight">\(\mu\)</span> into our model’s posterior, aiming to identify outliers that signify significant differences. By sampling from a Student-t distribution, which is informed by the model’s expectation for <span class="math notranslate nohighlight">\(\mu\)</span>, we can better identify variations in gene abundance. This method allows for a more accurate estimation of effect sizes, improving our ability to discern genuine genetic interactions amidst noise.</p>
<p><strong>Step 1: Pairwise Comparisons and Log-Fold Change Calculation</strong></p>
<p>The first pivotal step in our analysis involves conducting pairwise comparisons to discern the changes in gene abundance. This is achieved by calculating the log-fold change, a method that contrasts the logarithm of expected values <span class="math notranslate nohighlight">\(\mu\)</span> after the screen (<span class="math notranslate nohighlight">\(H_1\)</span>) against the log of <span class="math notranslate nohighlight">\(\mu\)</span> values before the screen (<span class="math notranslate nohighlight">\(H_0\)</span>). The formula for this calculation is straightforward yet powerful:</p>
<div class="math notranslate nohighlight">
\[
\text{FC} = \log(\mu_{\text{after}}) - \log(\mu_{\text{before}})
\]</div>
<p>By focusing on the log-fold change, we efficiently capture the relative differences in gene expression levels, providing a normalized measure that is less sensitive to the scale of changes and more indicative of biological significance. This step lays the groundwork for a deeper understanding of gene behavior in response to CRISPR-mediated modifications. `In the process of posterior sampling, the pairwise comparison is enhanced by subtracting the difference between one pair from all possible pairs <code class="docutils literal notranslate"><span class="pre">fc_dist</span> <span class="pre">=</span>&#160; <span class="pre">pm.Deterministic(&quot;fc_dist&quot;,fc[:,None]-fc[None])</span></code>. This technique allows for the identification of the most significant fold change (FC) differences across all measurements, offering a comprehensive view of the genetic landscape altered by the CRISPR screen.</p>
<p>The configuration with numpy for this analysis might seem a bit intricate at first glance. To clarify the approach and demonstrate how we apply these concepts in practice, let’s look at a matrix example. This will help to visually illustrate the process of conducting pairwise comparisons and understanding the differential expression analysis facilitated by numpy’s operations. See the figure below for a detailed example:</p>
<p><img alt="Pairwise Comparison Example" src="../../_images/p_2_output_7_0.png" /></p>
<p><strong>Step 2: Estimating Effect Size Using the Student-t Distribution</strong></p>
<p>Building on the pairwise comparisons and log-fold change calculations from Step 1, we now aim to quantify the effect size. This quantification is achieved by drawing from the Student-t distribution, where the mean of this distribution, denoted as <code class="docutils literal notranslate"><span class="pre">fc_dist</span></code>, represents the average effect size across our comparisons. To properly utilize the Student-t distribution for our purposes, we need to define priors for both <span class="math notranslate nohighlight">\(\nu\)</span> (degrees of freedom) and <span class="math notranslate nohighlight">\(\lambda\)</span> (precision or scale parameter).</p>
<p>The Student-t distribution is mathematically represented as follows:</p>
<div class="math notranslate nohighlight">
\[
f(x|\mu,\lambda,\nu) = \frac{\Gamma(\frac{\nu + 1}{2})}{\Gamma(\frac{\nu}{2})}\left(\frac{\lambda}{\pi\nu}\right)^{\frac{1}{2}}\left[1+\frac{\lambda(x-\mu)^2}{\nu}\right]^{-\frac{\nu+1}{2}}
\]</div>
<p><strong>Parameters:</strong></p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(\nu\)</span> (degrees of freedom): Controls the shape of the distribution. A higher value makes the distribution resemble a normal distribution.</p></li>
<li><p><span class="math notranslate nohighlight">\(\mu\)</span> (location parameter): Represents the mean of the distribution.</p></li>
<li><p><span class="math notranslate nohighlight">\(\sigma\)</span> (scale parameter, optional): Influences the spread of the distribution. It’s related inversely to <span class="math notranslate nohighlight">\(\lambda\)</span>.</p></li>
<li><p><span class="math notranslate nohighlight">\(\lambda\)</span> (precision parameter, optional): Also affects the distribution’s spread, where a higher value indicates less variance.</p></li>
</ul>
<p><strong>Understanding the Parameters and Their Impact:</strong></p>
<ul class="simple">
<li><p>The gamma function (<span class="math notranslate nohighlight">\(\Gamma\)</span>) in the formula adjusts the normalization based on the degrees of freedom, ensuring the distribution’s total area equals 1.</p></li>
<li><p>The degrees of freedom, <span class="math notranslate nohighlight">\(\nu\)</span>, affect the tails of the distribution. Lower values lead to heavier tails, which is useful for capturing outliers in effect size estimation.</p></li>
<li><p>The location parameter, <span class="math notranslate nohighlight">\(\mu\)</span>, aligns with our <code class="docutils literal notranslate"><span class="pre">fc_dist</span></code>, anchoring the distribution around the observed mean fold change.</p></li>
<li><p>The scale (<span class="math notranslate nohighlight">\(\sigma\)</span>) or precision (<span class="math notranslate nohighlight">\(\lambda\)</span>) parameters control the spread of the distribution, allowing us to model the variability of our effect sizes accurately.</p></li>
</ul>
<p>This distribution enables us to account for the uncertainty in our effect size estimates, providing a more robust and flexible framework than assuming normal distribution, especially valuable when dealing with outliers or smaller sample sizes.</p>
<p>The real strength of Bayesian statistics lies in its ability to incorporate rich datasets from previous experiments. This approach not only broadens our analytical framework but also enriches our understanding by integrating established findings into new analyses.</p>
<p>A prime example of tapping into such valuable resources is the use of public data on CRISPR screens. An outstanding repository for this purpose is <a class="reference external" href="https://orcs.thebiogrid.org/">BioGrid ORCS</a>, a comprehensive database of CRISPR screen outcomes. From this treasure trove, I’ve utilized the dataset from the work of <a class="reference external" href="https://doi.org/10.1016/j.molcel.2017.09.012">Jost et al</a>, which offers an in-depth CRISPR screen analysis of approximately 1000 genes, complete with their corresponding log2 fold changes (log2FC) and p-values.</p>
<p>Plotting this data unveils distinct differences in the parameters <span class="math notranslate nohighlight">\(\mu\)</span>, <span class="math notranslate nohighlight">\(\lambda\)</span>, and <span class="math notranslate nohighlight">\(\nu\)</span>, especially when focusing on a selected group of genes. These genes, significantly enriched compared to the rest, showcase variance in their effect sizes and underlying statistical distributions that are not immediately apparent without such a comparative analysis.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">filename</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;BIOGRID-ORCS-SCREEN_1184-1.1.14.screen.tab.txt&#39;</span><span class="p">]</span>
<span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;../data/BioGRID&quot;</span>
<span class="n">df_1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">filename</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">delimiter</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span> 

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">palette1</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s2">&quot;colorblind&quot;</span><span class="p">,</span><span class="mi">9</span><span class="p">)</span>
<span class="n">selcolor</span> <span class="o">=</span> <span class="p">[</span><span class="n">palette1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]]</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df_1</span><span class="p">[</span><span class="s2">&quot;SCORE.1&quot;</span><span class="p">],</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">df_1</span><span class="p">[</span><span class="s2">&quot;SCORE.2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">selcolor</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;-log10(p-value)&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Score&quot;</span><span class="p">)</span>
<span class="n">az</span><span class="o">.</span><span class="n">plot_kde</span><span class="p">(</span><span class="n">df_1</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;SCORE.1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">plot_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="n">selcolor</span><span class="p">[</span><span class="mi">0</span><span class="p">]},</span><span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">az</span><span class="o">.</span><span class="n">plot_kde</span><span class="p">(</span><span class="n">df_1</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">400</span><span class="p">:,</span> <span class="s2">&quot;SCORE.1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">plot_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="n">selcolor</span><span class="p">[</span><span class="mi">1</span><span class="p">]},</span><span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">az</span><span class="o">.</span><span class="n">plot_kde</span><span class="p">(</span><span class="n">df_1</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;SCORE.1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">plot_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="n">selcolor</span><span class="p">[</span><span class="mi">2</span><span class="p">]},</span><span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Selected Genes&quot;</span><span class="p">,</span> <span class="s2">&quot;Unselected Genes&quot;</span><span class="p">,</span> <span class="s2">&quot;Total Genes&quot;</span><span class="p">]</span>
<span class="n">palette1</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s2">&quot;colorblind&quot;</span><span class="p">,</span><span class="mi">9</span><span class="p">)</span>
<span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">palette1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span>
<span class="n">patches</span> <span class="o">=</span> <span class="p">[</span><span class="n">mpatches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">))]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">patches</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span><span class="n">fontsize</span> <span class="o">=</span> <span class="mi">8</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Jost et al. (2017) - BIOGRID-ORCS-SCREEN_1184&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Text(0.5, 0.98, &#39;Jost et al. (2017) - BIOGRID-ORCS-SCREEN_1184&#39;)
</pre></div>
</div>
<p><img alt="png" src="../../_images/p_2_output_9_1.png" /></p>
<p>By examining these parameters in the context of pre-existing data, it becomes evident that the selected gene group exhibits unique characteristics in their distribution of log2FC, underscoring the nuanced effects captured by our Bayesian model. This insight is invaluable, as it not only validates our model’s assumptions and priors but also highlights the potential for discovering subtle genetic interactions through the lens of Bayesian inference.</p>
<div class="admonition-utilizing-online-databases-for-testing-priors admonition">
<p class="admonition-title">Utilizing Online Databases for Testing Priors</p>
<p>Selecting appropriate priors is crucial in Bayesian analysis. For finding suitable priors, exploring online databases is beneficial. Two valuable resources are <a class="reference external" href="https://distribution-explorer.github.io/">Justin Bois’s website</a> for distribution insights and <a class="reference external" href="https://ben18785.shinyapps.io/distribution-zoo/">Ben Lambert and Fergus Cooper’s Distribution Zoo</a>. Additionally, PyMC’s <code class="docutils literal notranslate"><span class="pre">find_constrained_prior</span></code> tool helps specify and visualize prior ranges effectively.</p>
</div>
<p>To facilitate the testing the Bayesian model, I’ve developed the <code class="docutils literal notranslate"><span class="pre">PosteriorAnalysis</span></code> class. This class is designed to streamline the analysis by accepting a simulation object as input. It then processes this input through posterior simulation, incorporating the selected prior parameters. The main objective is to draw an Enrichment Score from the t-distribution, leveraging our model to understand the underlying gene enrichment dynamics effectively. This approach allows for a comprehensive assessment of the model’s performance and the impact of our chosen priors on the analysis outcomes.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>

```{code-cell} ipython3
from arviz import hdi
import re
import pdb
import matplotlib.patches as mpatches

class PosteriorAnalysis:
    def __init__(self,objSim, title = &quot;&quot;, cumulative = False):
        self.objSim = objSim
        self.trace = self.objSim[&quot;trace&quot;]
        self.coords = self.objSim[&quot;coords&quot;]
        self.model = self.objSim[&quot;model&quot;]
        self.sgRNA = self.objSim[&quot;sgRNA&quot;]
        self.Genes = self.objSim[&quot;Genes&quot;]
        self.h1 = self.objSim[&quot;Y&quot;]
        self.h0 = self.objSim[&quot;X&quot;]
        self.M = self.objSim[&quot;M&quot;]
        self.effective_sgRNA_flat = self.objSim[&quot;hit&quot;]
        self.dftall = self.objSim[&quot;dftall&quot;]
        self.dftall_h0 = self.dftall.loc[self.dftall[&quot;tag&quot;]==0,:]
        self.dftall_h1 = self.dftall.loc[self.dftall[&quot;tag&quot;]==1,:]
        self.dftall_M = self.dftall.loc[self.dftall[&quot;tag&quot;]==2,:]
        self.title = title
        self.cumulative = cumulative
        self.idata_dist = self.posteriorSimulation()
        self.FC_mean, self.FC = self.calcFC()
    
    def posteriorSimulation(self):
        with pm.Model(coords=self.coords):
          #Hyper-proirs
          beta_bar = pm.Flat(&quot;beta_bar&quot;)
          sigma_bar = pm.Flat(&quot;sigma_bar&quot;)
          theta_bar = pm.Flat(&quot;theta_bar&quot;)
          sigma_theta_bar = pm.Flat(&quot;sigma_theta_bar&quot;)
          #Hyper-proir noncentered
          z_beta = pm.Flat(&quot;z_beta&quot;, dims=(&quot;sgRNA&quot;))
          beta = pm.Flat(&quot;beta&quot;)
          z_theta = pm.Flat(&quot;z_theta&quot;, dims=(&quot;sgRNA&quot;))
          theta = pm.Flat(&quot;theta&quot;)
          chol = pm.Flat(&quot;chol&quot;)
          ve = pm.Flat(&quot;ve&quot;)
          Mu_Y = pm.Flat(&quot;Mu_Y&quot;,shape = len(self.dftall_h0))
          Mu_X = pm.Flat(&quot;Mu_X&quot;,shape = len(self.dftall_h0))  
          fc = pm.Deterministic(&quot;fc&quot;,pt.log(Mu_Y) - pt.log(Mu_X))
          #fc = pm.Deterministic(&quot;fc&quot;,Mu_Y[:,None]/Mu_X[None])
          fc_dist =  pm.Deterministic(&quot;fc_dist&quot;,fc[:,None]-fc[None]) 
          nu = pm.Uniform(&quot;nu&quot;,5,40)
          lambda_ = pm.Gamma(&quot;lambda_&quot;,alpha = 2.8,beta = 1.3)
          effect_size = pm.StudentT(&quot;effect_size&quot;, nu=nu, mu=fc_dist, lam=lambda_)
          sigma = pm.Flat(&quot;sigma&quot;,dims = (&quot;experiment&quot;))
          count_h0 = pm.Flat(&quot;count_h0&quot;)
          count_h1 = pm.Flat(&quot;count_h1&quot;)
          idata_dist = pm.sample_posterior_predictive(self.trace, var_names=[&#39;fc&#39;,&#39;effect_size&#39;])
        return idata_dist
    
    def calcFC(self):
        FC_mean =  self.idata_dist.posterior_predictive[&#39;effect_size&#39;].mean(dim=(&quot;chain&quot;,&quot;draw&quot;,&quot;effect_size_dim_3&quot;)).values
        FC = self.idata_dist.posterior_predictive[&#39;effect_size&#39;].mean(dim=&quot;effect_size_dim_3&quot;).values
        return FC_mean, FC
        
    def plotGeneLevel(self,ax):
        #mapping Gene
        geneMapIdx = {g:[] for g in self.dftall_h0.Gene.values}
        for z,g in enumerate(self.dftall_h0.Gene.values):
            geneMapIdx[g].append(z)
        for z,g in enumerate(self.dftall_h0.Gene.values):
            #pdb.set_trace()
            arrTemp = np.mean(hdi(self.FC[:,:,geneMapIdx[g]],skipna=True),axis=0)
            ax.plot([g,g],[arrTemp[0],arrTemp[1]], linestyle=&#39;solid&#39;,c= &#39;k&#39;)
            if any(g in element for element in self.effective_sgRNA_flat):
                ax.scatter(g,np.mean(self.FC_mean[geneMapIdx[g]]) ,alpha=0.6,facecolor=&quot;red&quot; ,edgecolor= &quot;black&quot;)
            else:
                ax.scatter(g,np.mean(self.FC_mean[geneMapIdx[g]]) ,alpha=0.6,facecolor=&quot;none&quot; ,edgecolor= &quot;black&quot;)
        for label in ax.get_xticklabels():
            label.set_rotation(45)
            label.set_fontsize(8)
        ax.set_ylabel(&quot;Enrichment Score&quot;)
        ax.hlines(y = [0.1,-0.1], xmin = -1, xmax = 21, color= &quot;red&quot;,linestyle=&#39;--&#39;, alpha=0.5)
        ax.set_xlabel(&quot;Gene&quot;)
        ax.set_title(self.title,fontdict = {&#39;fontsize&#39;:8})

    def colorPalette1(self):
        &#39;&#39;&#39;
        three color list
        &#39;&#39;&#39;
        palette1 = sns.color_palette(&quot;colorblind&quot;,9)
        selcolor = [palette1[i] for i in [0, 1, 2]]
        return selcolor
    
    def histPlotPara(self,arr,color,axkde):
        az.plot_kde(arr,plot_kwargs={&quot;color&quot;: color}, ax = axkde, textsize = 8.0,figsize = (4,3), cumulative=self.cumulative)
        axkde.set_title(self.title,fontdict = {&#39;fontsize&#39;:12})
        axkde.set_xlabel(&quot;Enrichment Score&quot;)
        
        
    def geneMaping(self):
        geneMapIdx = {g:[] for g in self.dftall_h0.Gene.values}
        for z,g in enumerate(self.dftall_h0.Gene.values):
            geneMapIdx[g].append(z)
        randomGene_index = [i for i in geneMapIdx.keys()]
        #UpregukatedGene
        selg = [re.sub(&#39;_._.*&#39;,&#39;&#39;,gene) for gene in self.effective_sgRNA_flat][0]
        randomGene_index.remove(selg)
        Selected = self.FC[:,:,geneMapIdx[selg]]
        Unselected = self.FC[:,:,geneMapIdx[randomGene_index[-1]]]
        return geneMapIdx,selg,Selected,Unselected,randomGene_index


    def plotStThist(self,ax):
        color = self.colorPalette1()
        geneMapIdx,selg,Selected,Unselected,_ = self.geneMaping()
        self.histPlotPara(arr = Selected.ravel(),color = color[0], axkde = ax)
        self.histPlotPara(arr = Unselected.ravel(),color = color[1], axkde = ax)
        self.histPlotPara(arr = self.FC.ravel(),color = color[2], axkde = ax)

</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.patches</span> <span class="k">as</span> <span class="nn">mpatches</span>
<span class="kn">import</span> <span class="nn">cloudpickle</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;dftall_10x.pkl&#39;</span> <span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">buff</span><span class="p">:</span>
    <span class="n">dftall_10x_dict</span> <span class="o">=</span> <span class="n">cloudpickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">buff</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">cloudpickle</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;dftall_1x.pkl&#39;</span> <span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">buff</span><span class="p">:</span>
    <span class="n">dftall_1x_dict</span> <span class="o">=</span> <span class="n">cloudpickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">buff</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">cloudpickle</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;dftall_3x.pkl&#39;</span> <span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">buff</span><span class="p">:</span>
    <span class="n">dftall_3x_dict</span> <span class="o">=</span> <span class="n">cloudpickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">buff</span><span class="p">)</span>
<span class="c1">#plt.rcParams[&quot;figure.figsize&quot;] = (4*3, 3*3)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span><span class="n">sharex</span><span class="o">=</span><span class="nb">all</span><span class="p">)</span>
<span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="n">PosteriorAnalysis</span><span class="p">(</span><span class="n">dftall_1x_dict</span><span class="p">,</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;MOI 1X&quot;</span><span class="p">,</span><span class="n">cumulative</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">plotStThist</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">PosteriorAnalysis</span><span class="p">(</span><span class="n">dftall_3x_dict</span><span class="p">,</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;MOI 3X&quot;</span><span class="p">,</span><span class="n">cumulative</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">plotStThist</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">PosteriorAnalysis</span><span class="p">(</span><span class="n">dftall_10x_dict</span><span class="p">,</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;MOI 10X&quot;</span><span class="p">,</span><span class="n">cumulative</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">plotStThist</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Selected Genes&quot;</span><span class="p">,</span> <span class="s2">&quot;Unselected Genes&quot;</span><span class="p">,</span> <span class="s2">&quot;Total Genes&quot;</span><span class="p">]</span>
<span class="n">palette1</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s2">&quot;colorblind&quot;</span><span class="p">,</span><span class="mi">9</span><span class="p">)</span>
<span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">palette1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span>
<span class="n">patches</span> <span class="o">=</span> <span class="p">[</span><span class="n">mpatches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">))]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">patches</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span><span class="n">fontsize</span> <span class="o">=</span> <span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><img alt="png" src="../../_images/p_2_output_13_9.png" /></p>
<p>In this exploration of CRISPR screen data, the impact of varying MOI levels is vividly illustrated. At MOI 1X, clarity prevails; selected genes are sharply delineated from unselected ones, facilitating straightforward identification. Advancing to MOI 3X introduces a subtle blend, as peaks representing selected and unselected genes begin to overlap, suggesting a moderate increase in complexity. The leap to MOI 10X unveils a marked challenge: the peaks merge significantly, indicating a high noise environment where sophisticated statistical methods are essential for discerning the true effects of the genes. Across these scenarios, the adaptability of Bayesian inference is put to the test, proving its value in extracting reliable conclusions from intricate genetic screen data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.patches</span> <span class="k">as</span> <span class="nn">mpatches</span>
<span class="kn">import</span> <span class="nn">cloudpickle</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;dftall_10x.pkl&#39;</span> <span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">buff</span><span class="p">:</span>
    <span class="n">dftall_10x_dict</span> <span class="o">=</span> <span class="n">cloudpickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">buff</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">cloudpickle</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;dftall_1x.pkl&#39;</span> <span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">buff</span><span class="p">:</span>
    <span class="n">dftall_1x_dict</span> <span class="o">=</span> <span class="n">cloudpickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">buff</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">cloudpickle</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;dftall_3x.pkl&#39;</span> <span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">buff</span><span class="p">:</span>
    <span class="n">dftall_3x_dict</span> <span class="o">=</span> <span class="n">cloudpickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">buff</span><span class="p">)</span>
<span class="c1">#plt.rcParams[&quot;figure.figsize&quot;] = (4*3, 3*3)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span><span class="n">sharex</span><span class="o">=</span><span class="nb">all</span><span class="p">)</span>
<span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="n">PosteriorAnalysis</span><span class="p">(</span><span class="n">dftall_1x_dict</span><span class="p">,</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;MOI 1X&quot;</span><span class="p">,</span><span class="n">cumulative</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">plotStThist</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">PosteriorAnalysis</span><span class="p">(</span><span class="n">dftall_3x_dict</span><span class="p">,</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;MOI 3X&quot;</span><span class="p">,</span><span class="n">cumulative</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">plotStThist</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">PosteriorAnalysis</span><span class="p">(</span><span class="n">dftall_10x_dict</span><span class="p">,</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;MOI 10X&quot;</span><span class="p">,</span><span class="n">cumulative</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">plotStThist</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Selected Genes&quot;</span><span class="p">,</span> <span class="s2">&quot;Unselected Genes&quot;</span><span class="p">,</span> <span class="s2">&quot;Total Genes&quot;</span><span class="p">]</span>
<span class="n">palette1</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s2">&quot;colorblind&quot;</span><span class="p">,</span><span class="mi">9</span><span class="p">)</span>
<span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">palette1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span>
<span class="n">patches</span> <span class="o">=</span> <span class="p">[</span><span class="n">mpatches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">))]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">patches</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span><span class="n">fontsize</span> <span class="o">=</span> <span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><img alt="png" src="../../_images/p_2_output_15_9.png" /></p>
<p>ROPE analysis provides a statistical framework for hypothesis testing in applied research by defining a region of practical equivalence for parameter values. In this method, if the posterior distribution of a parameter lies completely within the ROPE, the difference is deemed negligible; outside the ROPE, the null hypothesis can be rejected. Employing PosteriorAnalysis.plotGeneLevel allows for precise hypothesis testing in CRISPR data, where even small variations are critical.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;dftall_10x.pkl&#39;</span> <span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">buff</span><span class="p">:</span>
    <span class="n">dftall_10x_dict</span> <span class="o">=</span> <span class="n">cloudpickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">buff</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;dftall_1x.pkl&#39;</span> <span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">buff</span><span class="p">:</span>
    <span class="n">dftall_1x_dict</span> <span class="o">=</span> <span class="n">cloudpickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">buff</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;dftall_3x.pkl&#39;</span> <span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">buff</span><span class="p">:</span>
    <span class="n">dftall_3x_dict</span> <span class="o">=</span> <span class="n">cloudpickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">buff</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span><span class="n">sharey</span><span class="o">=</span><span class="nb">all</span><span class="p">)</span>
<span class="n">PosteriorAnalysis</span><span class="p">(</span><span class="n">dftall_1x_dict</span><span class="p">,</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;MOI 1X&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">plotGeneLevel</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">PosteriorAnalysis</span><span class="p">(</span><span class="n">dftall_3x_dict</span><span class="p">,</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;MOI 3X&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">plotGeneLevel</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">PosteriorAnalysis</span><span class="p">(</span><span class="n">dftall_10x_dict</span><span class="p">,</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;MOI 10X&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">plotGeneLevel</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.12</span><span class="p">,</span> <span class="s2">&quot;ROPE&quot;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>  <span class="n">va</span><span class="o">=</span><span class="s2">&quot;top&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><img alt="png" src="../../_images/p_2_output_17_9.png" /></p>
<p>In all three plots at MOI levels 1X, 3X, and 10X, the true hits—indicated by red filled points—consistently register above the ROPE threshold. This indicates that even with increasing noise, the true effects remain distinguishable from the null hypothesis. However, the spread of the Highest Density Interval (HDI) for these true hits is noticeably wider at lower MOI, suggesting a stronger statistical confidence in those conditions. Despite the noise at higher MOI levels, the true hits still maintain a clear separation from the ROPE limit, affirming their significance.</p>
</section>
</section>

<div class="section">
    

<div class="section">
  <span style="float: left">
     
    <a href="bayesCell_analysis.html">
      <i class="fa fa-arrow-circle-left"></i> Using the Bayesian Approach with PyMC to Analyze Functional Genomics Screens, Part 1
    </a>
    
  </span>
  <span>&nbsp;</span>
  <span style="float: right">
    
  </span>
</div>
  
</div>

                </article>
              
              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">

  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#advancing-gene-enrichment-analysis-abundance-testing-using-bayesian-inference">Advancing Gene Enrichment Analysis: Abundance Testing Using Bayesian Inference</a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">

  <div class="tocsection sourcelink">
    <a href="../../_sources/blog/2024/bayesCell_analysis_Part2.md.txt">
      <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
  </div>
</div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=5b4479735964841361fd"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright Gil Kanfer.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.3.0.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.14.4.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>